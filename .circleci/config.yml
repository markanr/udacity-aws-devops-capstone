# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  kubernetes: circleci/kubernetes@0.11.2
  aws-eks: circleci/aws-eks@1.0.3

jobs:
    lint-app:
        docker:
            - image: python:3.7.3-stretch

        working_directory: ~/repo

        steps:
            - checkout
            - restore_cache:
                keys:
                - v1-dependencies-{{ checksum "requirements.txt" }}
                - v1-dependencies-
            - run:
                name: install dependencies
                command: |
                    make setup
                    source venv/bin/activate
                    make install
                    # Install hadolint
                    wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
                    chmod +x /bin/hadolint
            - run:
                name: run lint
                command: |
                    . venv/bin/activate
                    make lint 
            - save_cache:
                paths:
                    - ./venv
                key: v1-dependencies-{{ checksum "requirements.txt" }}
          
workflows:
  default:
    jobs:
      - lint-app